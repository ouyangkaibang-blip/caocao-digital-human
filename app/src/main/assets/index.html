<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°å­—äººç³»ç»Ÿ</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      height: 100vh;
      background-color: #000;
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    /* ä¸»å®¹å™¨ - 16:9ç«–å±æ¯”ä¾‹ */
    #main-container {
      width: 56.25vh; /* 16:9ç«–å±æ¯”ä¾‹ (9/16 * 100vh) */
      height: 100vh;
      max-width: 100vw;
      position: relative;
      background-color: #000;
      overflow: hidden;
    }
    
    /* æ•°å­—äººè§†é¢‘åŒºåŸŸ - å…¨å± */
    #video-container {
      width: 100%;
      height: 100%;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    #digital-human-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    #status-indicator {
      position: absolute;
      top: 0px;
      left: 0px;
      padding: 24px 48px;
      background-color: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 0px 0px 60px 0px;
      font-size: 42px;
      z-index: 150;
      backdrop-filter: blur(10px);
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s ease;
      margin: 0;
      border: none;
    }
    
    #status-indicator:hover {
      background-color: rgba(0, 0, 0, 0.9);
    }
    
    .status-idle { background-color: rgba(40, 167, 69, 0.8) !important; }
    .status-thinking { background-color: rgba(255, 193, 7, 0.8) !important; }
    .status-speaking { background-color: rgba(0, 123, 255, 0.8) !important; }
    
    /* é€æ˜å¯¹è¯è¦†ç›–å±‚ */
    #chat-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 40%;
      background: transparent;
      display: flex;
      flex-direction: column;
      z-index: 50;
      pointer-events: none;
    }
    
    /* å¯¹è¯å†å²åŒºåŸŸ */
    #chat-history {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: auto;
    }
    
    .message {
      padding: 12px 16px;
      border-radius: 18px;
      max-width: 80%;
      backdrop-filter: blur(10px);
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
      background-color: rgba(0, 123, 255, 0.9);
      color: white;
      margin-left: auto;
      text-align: right;
    }
    
    .ai-message {
      background-color: rgba(255, 255, 255, 0.9);
      color: #333;
      margin-right: auto;
    }
    
    .message-header {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 4px;
      font-weight: bold;
    }
    
    /* è¾“å…¥åŒºåŸŸ */
    #input-area {
      padding: 20px;
      pointer-events: auto;
    }
    
    #user-input {
      width: 100%;
      padding: 15px 20px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      outline: none;
      margin-bottom: 15px;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      color: #333;
    }
    
    #user-input::placeholder {
      color: #666;
    }
    
    #user-input:focus {
      background-color: rgba(255, 255, 255, 0.95);
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.5);
    }
    
    /* æŒ‰é’®åŒºåŸŸ */
    #button-area {
      display: flex;
      gap: 10px;
      justify-content: space-between;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }
    
    #send-button {
      background-color: rgba(0, 123, 255, 0.9);
      color: white;
      flex: 2;
    }
    
    #send-button:hover {
      background-color: rgba(0, 123, 255, 1);
      transform: translateY(-2px);
    }
    
    #send-button:disabled {
      background-color: rgba(108, 117, 125, 0.6);
      cursor: not-allowed;
      transform: none;
    }
    
    #interrupt-button {
      background-color: rgba(220, 53, 69, 0.9);
      color: white;
      flex: 1;
    }
    
    #interrupt-button:hover {
      background-color: rgba(220, 53, 69, 1);
      transform: translateY(-2px);
    }
    
    #voice-button {
      background-color: rgba(40, 167, 69, 0.9);
      color: white;
      flex: 1;
      position: relative;
    }
    
    #voice-button.voice-on {
      background-color: rgba(220, 53, 69, 0.9);
      animation: pulse 1.5s infinite;
    }
    
    #voice-button.voice-off {
      background-color: rgba(40, 167, 69, 0.9);
    }
    
    #voice-button:hover {
      background-color: rgba(40, 167, 69, 1);
      transform: translateY(-2px);
    }
    
    #voice-button.voice-on:hover {
      background-color: rgba(220, 53, 69, 1);
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
    }

    #settings-button {
      background-color: rgba(108, 117, 125, 0.9);
      color: white;
      flex: 1;
    }
    
    #settings-button:hover {
      background-color: rgba(108, 117, 125, 1);
      transform: translateY(-2px);
    }
    
    /* æ»šåŠ¨æ¡æ ·å¼ */
    #chat-history::-webkit-scrollbar {
      width: 6px;
    }
    
    #chat-history::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
    }
    
    #chat-history::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }
    
    #chat-history::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      #main-container {
        width: 100vw;
        height: 100vh;
      }
      
      #chat-overlay {
        height: 45%;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 12px;
      }
      
      #user-input {
        padding: 12px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- ä¸»å®¹å™¨ - 16:9ç«–å±æ¯”ä¾‹ -->
  <div id="main-container">
    <!-- æ•°å­—äººè§†é¢‘åŒºåŸŸ - å…¨å±èƒŒæ™¯ -->
    <div id="video-container">
      <div id="status-indicator" class="status-idle">å¾…æœºä¸­</div>
      <video id="digital-human-video" autoplay loop muted>
        <source src="/shucai/é™æ­¢.mp4" type="video/mp4">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
      </video>
      <!-- ç”¨äºå¹³æ»‘åˆ‡æ¢çš„å¤‡ç”¨è§†é¢‘ -->
      <video id="digital-human-video-alt" autoplay loop muted style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; pointer-events: none;">
        <source src="/shucai/é™æ­¢.mp4" type="video/mp4">
      </video>
    </div>
    
    <!-- é€æ˜å¯¹è¯è¦†ç›–å±‚ -->
    <div id="chat-overlay">
      <!-- å¯¹è¯å†å²åŒºåŸŸ -->
      <div id="chat-history">
        <div class="message ai-message">
          <div class="message-header">æ›¹æ“</div>
          <div>æ‚¨å¥½ï¼æˆ‘æ˜¯æ›¹æ“ï¼Œæœ‰ä»€ä¹ˆæƒ³ä¸æˆ‘è®¨è®ºçš„å—ï¼Ÿ</div>
        </div>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div id="input-area">
        <input type="text" id="user-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." />
        <div id="button-area">
          <button id="send-button" class="btn">å‘é€</button>
          <button id="voice-button" class="btn voice-off">ğŸ¤ è¯­éŸ³</button>
          <button id="interrupt-button" class="btn">æ‰“æ–­</button>
          <button id="settings-button" class="btn" onclick="handleSettings()">è®¾ç½®</button>
        </div>
        <div id="network-status" style="display: none; color: orange; font-size: 12px; text-align: center; margin-top: 5px;">
          âš ï¸ è¯­éŸ³è¯†åˆ«ç½‘ç»œå—é™ï¼Œå»ºè®®ä½¿ç”¨æ–‡å­—è¾“å…¥ (æŒ‰å›è½¦å‘é€)
        </div>
      </div>
    </div>
  </div>

  <!-- è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡† -->
  <div id="custom-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);">
      <h3 id="modal-title" style="margin-top: 0; color: #333;">æ ‡é¢˜</h3>
      <p id="modal-message" style="color: #666; margin: 20px 0;">æ¶ˆæ¯å†…å®¹</p>
      <input id="modal-input" type="text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; box-sizing: border-box; display: none;">
      <select id="modal-select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0; box-sizing: border-box; display: none;"></select>
      <div style="margin-top: 20px;">
        <button id="modal-cancel" style="padding: 10px 20px; margin: 0 5px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
        <button id="modal-ok" style="padding: 10px 20px; margin: 0 5px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer;">ç¡®å®š</button>
      </div>
    </div>
  </div>

  <script>
    // DOM å…ƒç´ è·å–
    const videoElement = document.getElementById('digital-human-video');
    const videoElementAlt = document.getElementById('digital-human-video-alt');
    const chatHistory = document.getElementById('chat-history');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const voiceButton = document.getElementById('voice-button');
    const interruptButton = document.getElementById('interrupt-button');
    const settingsButton = document.getElementById('settings-button');
    const statusIndicator = document.getElementById('status-indicator');

    // åº”ç”¨çŠ¶æ€
    let currentState = 'idle'; // idle, thinking, speaking
    let isProcessing = false;
    let isSpeaking = false;
    
    // é™æ­¢çŠ¶æ€å®šæ—¶å™¨ç®¡ç†
    let idleTimer = null;
    let isInCalmState = false; // æ˜¯å¦å¤„äºå¹³é™é™æ­¢çŠ¶æ€
    let stillVideoPlayCount = 0; // é™æ­¢è§†é¢‘å·²æ’­æ”¾æ¬¡æ•°
    let hasPlayedWelcome = false; // æ˜¯å¦å·²æ’­æ”¾æ¬¢è¿è¯­éŸ³
    
    // è‡ªå®šä¹‰çŠ¶æ€æ–‡æœ¬
    let customStatusTexts = {
      idle: 'å¾…æœºä¸­',
      thinking: 'æ€è€ƒä¸­',
      speaking: 'å¯¹è¯ä¸­',
      listening: 'è†å¬ä¸­'
    };

    // è‡ªå®šä¹‰æ¨¡æ€å¯¹è¯æ¡†å‡½æ•°
    function showCustomPrompt(title, message, defaultValue = '') {
      return new Promise((resolve) => {
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalSelect = document.getElementById('modal-select');
        const modalOk = document.getElementById('modal-ok');
        const modalCancel = document.getElementById('modal-cancel');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalInput.value = defaultValue;
        modalInput.style.display = 'block';
        modalSelect.style.display = 'none';
        
        modal.style.display = 'flex';
        modalInput.focus();

        const handleOk = () => {
          const value = modalInput.value;
          modal.style.display = 'none';
          modalOk.removeEventListener('click', handleOk);
          modalCancel.removeEventListener('click', handleCancel);
          resolve(value);
        };

        const handleCancel = () => {
          modal.style.display = 'none';
          modalOk.removeEventListener('click', handleOk);
          modalCancel.removeEventListener('click', handleCancel);
          resolve(null);
        };

        modalOk.addEventListener('click', handleOk);
        modalCancel.addEventListener('click', handleCancel);
        
        // å›è½¦é”®ç¡®è®¤
        modalInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            handleOk();
          } else if (e.key === 'Escape') {
            handleCancel();
          }
        });
      });
    }

    function showCustomSelect(title, message, options) {
      return new Promise((resolve) => {
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalSelect = document.getElementById('modal-select');
        const modalOk = document.getElementById('modal-ok');
        const modalCancel = document.getElementById('modal-cancel');

        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalInput.style.display = 'none';
        modalSelect.style.display = 'block';
        
        // æ¸…ç©ºå¹¶å¡«å……é€‰é¡¹
        modalSelect.innerHTML = '';
        options.forEach((option, index) => {
          const optionElement = document.createElement('option');
          optionElement.value = index + 1;
          optionElement.textContent = option;
          modalSelect.appendChild(optionElement);
        });
        
        modal.style.display = 'flex';
        modalSelect.focus();

        const handleOk = () => {
          const value = modalSelect.value;
          modal.style.display = 'none';
          modalOk.removeEventListener('click', handleOk);
          modalCancel.removeEventListener('click', handleCancel);
          resolve(value);
        };

        const handleCancel = () => {
          modal.style.display = 'none';
          modalOk.removeEventListener('click', handleOk);
          modalCancel.removeEventListener('click', handleCancel);
          resolve(null);
        };

        modalOk.addEventListener('click', handleOk);
        modalCancel.addEventListener('click', handleCancel);
      });
    }
    
    // è¯­éŸ³åˆæˆç›¸å…³
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let selectedVoice = null;
    let currentAudio = null;           // å½“å‰æ’­æ”¾çš„æœåŠ¡ç«¯éŸ³é¢‘
    let currentAudioUrl = null;        // å½“å‰éŸ³é¢‘URLï¼Œä¾¿äºé‡Šæ”¾
    let speakToken = 0;                // é€’å¢ä»¤ç‰Œï¼Œä¿è¯åªæ’­æ”¾æœ€æ–°ä¸€æ®µ
    
    // è¯­éŸ³è¯†åˆ«ç›¸å…³ï¼ˆæ”¹ä¸ºæœ¬åœ°ASRï¼‰
    let speechRecognition = null;      // ä»ä¿ç•™å˜é‡åä»¥æœ€å°åŒ–æ”¹åŠ¨ï¼Œä½†ä¸å†ä½¿ç”¨æµè§ˆå™¨API
    let isVoiceEnabled = false;        // è¯­éŸ³è¾“å…¥æ˜¯å¦å¼€å¯
    let isListening = false;           // æ˜¯å¦æ­£åœ¨ç›‘å¬
    let voiceRecognitionSupported = true; // ä½¿ç”¨æœ¬åœ°ASRï¼Œè§†ä¸ºæ”¯æŒ
    let mediaStream = null;            // éº¦å…‹é£æµ
    let audioContextRef = null;        // éŸ³é¢‘ä¸Šä¸‹æ–‡
    let sourceRef = null;              // éŸ³é¢‘æº
    let processorRef = null;           // å¤„ç†å™¨
    let recordedFloat32 = [];          // å·²å½•åˆ¶çš„æµ®ç‚¹éŸ³é¢‘
    let isAsrRequesting = false;       // æ˜¯å¦æ­£åœ¨è¯·æ±‚ASR
    let lastPartialAt = 0;             // ä¸Šæ¬¡éƒ¨åˆ†è¯†åˆ«æ—¶é—´
    let lastPartialText = '';          // æœ€è¿‘ä¸€æ¬¡éƒ¨åˆ†è¯†åˆ«æ–‡æœ¬
    let accumulatedSilenceMs = 0;      // é™éŸ³ç´¯è®¡æ—¶é•¿
    let heardAnyVoice = false;         // æ˜¯å¦å‡ºç°è¿‡æœ‰æ•ˆå£°éŸ³
    const SILENCE_LEVEL = 0.015;       // é™éŸ³é˜ˆå€¼(å‡æ–¹æ ¹)
    const SILENCE_END_MS = 3000;       // é™éŸ³3ç§’åˆ¤å®šç»“æŸ
    const ASR_URL = 'http://localhost:3002/asr';

    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«ï¼ˆæœ¬åœ°ASRï¼Œæ— éœ€å¤–ç½‘ï¼‰
    async function initializeSpeechRecognition() {
      console.log('åˆå§‹åŒ–æœ¬åœ°ASRå½•éŸ³');
      try {
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: { echoCancellation: true, noiseSuppression: true }
        });
        console.log('éº¦å…‹é£æƒé™å·²è·å–');
      } catch (e) {
        console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', e);
        alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿä¸æµè§ˆå™¨æƒé™');
        voiceButton.disabled = true;
        return;
      }
      console.log('æœ¬åœ°ASRåˆå§‹åŒ–å®Œæˆ');
    }

    // æµ‹è¯•è¯­éŸ³è¯†åˆ«ç½‘ç»œè¿æ¥
    async function testSpeechRecognitionConnectivity() {
      console.log('æµ‹è¯•è¯­éŸ³è¯†åˆ«ç½‘ç»œè¿æ¥...');
      
      try {
        // å°è¯•è®¿é—®Googleçš„è¯­éŸ³è¯†åˆ«æœåŠ¡åŸŸå
        const testUrls = [
          'https://www.google.com/speech-api/v2/recognize',
          'https://speech.googleapis.com',
          'https://www.google.com'
        ];
        
        let accessible = false;
        for (const url of testUrls) {
          try {
            const response = await fetch(url, { 
              method: 'HEAD', 
              mode: 'no-cors',
              timeout: 3000 
            });
            accessible = true;
            console.log(`âœ“ å¯ä»¥è®¿é—®è¯­éŸ³è¯†åˆ«æœåŠ¡: ${url}`);
            break;
          } catch (e) {
            console.log(`âœ— æ— æ³•è®¿é—®: ${url}`);
          }
        }
        
        if (!accessible) {
          console.warn('âš ï¸  è¯­éŸ³è¯†åˆ«æœåŠ¡å¯èƒ½æ— æ³•è®¿é—®ï¼Œå»ºè®®ä½¿ç”¨æ–‡å­—è¾“å…¥');
          userInput.placeholder = 'ç½‘ç»œå—é™ï¼Œå»ºè®®ä½¿ç”¨æ–‡å­—è¾“å…¥ (æŒ‰å›è½¦å‘é€)';
          
          // æ˜¾ç¤ºç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨
          const networkStatus = document.getElementById('network-status');
          if (networkStatus) {
            networkStatus.style.display = 'block';
          }
          
          // ç¦ç”¨è¯­éŸ³æŒ‰é’®å¹¶æç¤º
          voiceButton.disabled = true;
          voiceButton.textContent = 'ğŸ¤ ç½‘ç»œå—é™';
          voiceButton.style.opacity = '0.5';
          
          // æ·»åŠ æ˜æ˜¾çš„æç¤º
          setTimeout(() => {
            if (!isVoiceEnabled) {
              addMessage('æ£€æµ‹åˆ°ç½‘ç»œè¿æ¥é—®é¢˜ï¼Œè¯­éŸ³è¯†åˆ«æ— æ³•ä½¿ç”¨ã€‚è¯·ç›´æ¥è¾“å…¥æ–‡å­—è¿›è¡Œå¯¹è¯ï¼ŒæŒ‰å›è½¦é”®å‘é€ã€‚', false);
            }
          }, 2000);
        } else {
          console.log('âœ“ è¯­éŸ³è¯†åˆ«ç½‘ç»œè¿æ¥æ­£å¸¸');
        }
      } catch (error) {
        console.error('ç½‘ç»œè¿æ¥æµ‹è¯•å¤±è´¥:', error);
      }
    }

    // åˆå§‹åŒ–è¯­éŸ³åˆæˆï¼Œé€‰æ‹©ä¸­å¹´ç”·æ€§å£°éŸ³
    function initializeTTS() {
      // ç­‰å¾…è¯­éŸ³åˆ—è¡¨åŠ è½½å®Œæˆ
      if (speechSynthesis.getVoices().length === 0) {
        speechSynthesis.addEventListener('voiceschanged', selectMaleVoice);
      } else {
        selectMaleVoice();
      }
    }

    // é€‰æ‹©ä¸­å¹´ç”·æ€§å£°éŸ³
    function selectMaleVoice() {
      const voices = speechSynthesis.getVoices();
      console.log('å¯ç”¨è¯­éŸ³:', voices.map(v => `${v.name} - ${v.lang} - ${v.gender || 'unknown'}`));
      
      // ä¼˜å…ˆé€‰æ‹©ä¸­æ–‡ç”·æ€§å£°éŸ³
      const preferredVoices = [
        'Microsoft Yunyang - Chinese (Mainland)', // Windows ä¸­æ–‡ç”·å£°
        'Microsoft Kangkang - Chinese (Mainland)', // Windows ä¸­æ–‡ç”·å£°
        'Google æ™®é€šè¯ï¼ˆä¸­å›½å¤§é™†ï¼‰', // Chrome ä¸­æ–‡
        'zh-CN', // é€šç”¨ä¸­æ–‡
        'Ting-Ting',
        'Sin-ji',
      ];
      
      for (let preferred of preferredVoices) {
        const voice = voices.find(v => 
          v.name.includes(preferred) || 
          (v.lang.includes('zh') && v.name.toLowerCase().includes('male')) ||
          (v.lang.includes('zh') && v.name.includes('ç”·'))
        );
        if (voice) { selectedVoice = voice; return; }
      }
      const chineseVoice = voices.find(v => v.lang.includes('zh'));
      selectedVoice = chineseVoice || voices[0] || null;
    }

    // åˆå§‹åŒ–éŸ³é¢‘æ£€æµ‹
    async function initAudioDetection() {
      try {
        // è¯·æ±‚éº¦å…‹é£æƒé™
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          } 
        });
        
        // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        microphone = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        
        analyser.fftSize = 256;
        microphone.connect(analyser);
        
        console.log('éŸ³é¢‘æ£€æµ‹åˆå§‹åŒ–æˆåŠŸ');
        return true;
      } catch (error) {
        console.error('éŸ³é¢‘æ£€æµ‹åˆå§‹åŒ–å¤±è´¥:', error);
        return false;
      }
    }

    // æ£€æµ‹éŸ³é¢‘è¾“å…¥çº§åˆ«
    function checkAudioLevel() {
      if (!analyser) return 0;
      
      const bufferLength = analyser.frequencyBinCount;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteFrequencyData(dataArray);
      
      let sum = 0;
      for (let i = 0; i < bufferLength; i++) {
        sum += dataArray[i];
      }
      
      const average = sum / bufferLength;
      return average;
    }

    // å°†Float32 PCMè½¬ä¸º16bit PCMå­—èŠ‚
    function floatTo16BitPCM(float32Array) {
      const buffer = new ArrayBuffer(float32Array.length * 2);
      const view = new DataView(buffer);
      for (let i = 0; i < float32Array.length; i++) {
        let s = Math.max(-1, Math.min(1, float32Array[i]));
        view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
      }
      return buffer;
    }

    // ç”Ÿæˆç®€å•WAV(PCM16, å•å£°é“, 16k)
    function encodeWAVFromFloat32(float32Array, sampleRate) {
      // é‡é‡‡æ ·åˆ°16kï¼ˆæœ€ç®€å•çš„æŠ½æ ·æ³•ï¼Œå¤Ÿç”¨ï¼‰
      const targetRate = 16000;
      const ratio = sampleRate / targetRate;
      const newLength = Math.floor(float32Array.length / ratio);
      const resampled = new Float32Array(newLength);
      for (let i = 0; i < newLength; i++) {
        resampled[i] = float32Array[Math.floor(i * ratio)] || 0;
      }

      const pcmBuffer = floatTo16BitPCM(resampled);
      const wavBuffer = new ArrayBuffer(44 + resampled.length * 2);
      const view = new DataView(wavBuffer);

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }

      // RIFF/WAVE å¤´
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + resampled.length * 2, true);
      writeString(view, 8, 'WAVE');
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true); // PCM chunk size
      view.setUint16(20, 1, true);  // PCM format
      view.setUint16(22, 1, true);  // mono
      view.setUint32(24, targetRate, true);
      view.setUint32(28, targetRate * 2, true); // byte rate
      view.setUint16(32, 2, true);  // block align
      view.setUint16(34, 16, true); // bits per sample
      writeString(view, 36, 'data');
      view.setUint32(40, resampled.length * 2, true);

      // PCM æ•°æ®
      const pcmView = new Uint8Array(pcmBuffer);
      new Uint8Array(wavBuffer, 44).set(pcmView);
      return new Blob([wavBuffer], { type: 'audio/wav' });
    }

    // ç®€æ˜“ä¸­æ–‡æ ‡ç‚¹æ¢å¤
    function restoreChinesePunctuation(input) {
      if (!input) return input;
      let text = String(input).replace(/\s+/g, '').trim();
      if (!text) return text;

      // å°†è‹±æ–‡æ ‡ç‚¹æ›¿æ¢ä¸ºä¸­æ–‡
      text = text.replace(/,/g, 'ï¼Œ').replace(/;/g, 'ï¼›').replace(/!/g, 'ï¼').replace(/\?/g, 'ï¼Ÿ');

      // åœ¨è¿æ¥è¯å‰è¡¥é€—å·ï¼ˆé¿å…å¥é¦–è¡¥é€—å·ï¼‰
      const markers = ['ç„¶å','ä½†æ˜¯','ä¸è¿‡','è€Œä¸”','æ‰€ä»¥','å› æ­¤','åŒæ—¶','å¦å¤–','è¿˜æœ‰','ä»¥åŠ','å¯æ˜¯','ç„¶è€Œ','å¦‚æœ','å› ä¸º','æ¯”å¦‚','ä¾‹å¦‚','é¦–å…ˆ','å…¶æ¬¡','æœ€å'];
      markers.forEach(m => {
        const reg = new RegExp(`([^ï¼Œã€‚ï¼ï¼Ÿï¼›ã€\n^])${m}`, 'g');
        text = text.replace(reg, `$1ï¼Œ${m}`);
      });

      // ç»“å°¾æ ‡ç‚¹ï¼šç–‘é—®å¥åˆ¤å®š
      const isQuestion = /(å—|å‘¢|æ˜¯ä¸æ˜¯|ä¸ºä½•|ä¸ºä»€ä¹ˆ|æ€ä¹ˆ|æ€æ ·|å¤šå°‘|å‡ ç‚¹|å‡ æ—¶|å“ª[å„¿é‡Œå›½ç§ä¸ª]|è°|æ˜¯å¦|èƒ½å¦|å¯å¦|å¯ä¸å¯ä»¥|å¥½ä¸å¥½|è¦ä¸è¦|å¯¹ä¸å¯¹)$/
        .test(text) || /^(ä¸ºä»€ä¹ˆ|æ€ä¹ˆ|æ˜¯å¦|å“ª|è°|ä½•æ—¶|å‡ ç‚¹|å¤šä¹…|å¤šè¿œ)/.test(text);
      if (!/[ã€‚ï¼ï¼Ÿ?ï¼]$/.test(text)) {
        text += isQuestion ? 'ï¼Ÿ' : 'ã€‚';
      }

      // åˆå¹¶é‡å¤æ ‡ç‚¹
      text = text.replace(/ï¼Œ{2,}/g, 'ï¼Œ').replace(/ã€‚{2,}/g, 'ã€‚').replace(/ï¼ï¼+/g, 'ï¼').replace(/ï¼Ÿï¼Ÿ+/g, 'ï¼Ÿ');
      return text;
    }

    function computeRMS(float32) {
      let sum = 0;
      for (let i = 0; i < float32.length; i++) {
        const v = float32[i];
        sum += v * v;
      }
      return Math.sqrt(sum / float32.length);
    }

    async function requestASRPartial(audioContext, mergedFloat32) {
      try {
        isAsrRequesting = true;
        const wavBlob = encodeWAVFromFloat32(mergedFloat32, audioContext.sampleRate);
        const form = new FormData();
        form.append('audio', wavBlob, 'speech.wav');
        const resp = await fetch(ASR_URL, { method: 'POST', body: form });
        const data = await resp.json();
        if (data && data.text) {
          const text = data.text.trim();
          if (text) {
            lastPartialText = text;
            userInput.value = text;
            userInput.style.fontStyle = 'italic';
            userInput.style.opacity = '0.8';
            console.log('ASRè¯†åˆ«ç»“æœ:', text);
          }
        }
      } catch (e) {
        console.warn('éƒ¨åˆ†è¯†åˆ«å¤±è´¥:', e);
      } finally {
        isAsrRequesting = false;
      }
    }

    async function startVoiceRecognition() {
      if (!mediaStream) {
        await initializeSpeechRecognition();
        if (!mediaStream) return;
      }
      if (isListening) return;

      isListening = true;
      voiceButton.className = 'btn voice-on';
      voiceButton.textContent = 'ğŸ¤ è†å¬ä¸­';
      userInput.placeholder = 'æ­£åœ¨è†å¬æ‚¨çš„å£°éŸ³...';
      
      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      statusIndicator.textContent = customStatusTexts.listening;
      statusIndicator.className = 'status-speaking';

      // åˆå§‹åŒ–éŸ³é¢‘å›¾
      audioContextRef = new (window.AudioContext || window.webkitAudioContext)();
      sourceRef = audioContextRef.createMediaStreamSource(mediaStream);
      processorRef = audioContextRef.createScriptProcessor(4096, 1, 1);
      sourceRef.connect(processorRef);
      processorRef.connect(audioContextRef.destination);

      // é‡ç½®çŠ¶æ€
      recordedFloat32 = [];
      accumulatedSilenceMs = 0;
      heardAnyVoice = false;
      lastPartialText = '';
      lastPartialAt = 0;

      processorRef.onaudioprocess = async (e) => {
        if (!isListening) return;
        const input = e.inputBuffer.getChannelData(0);
        recordedFloat32.push(new Float32Array(input));

        const rms = computeRMS(input);
        const frameMs = (input.length / audioContextRef.sampleRate) * 1000;
        if (rms > SILENCE_LEVEL) {
          accumulatedSilenceMs = 0;
          heardAnyVoice = true;
        } else if (heardAnyVoice) {
          accumulatedSilenceMs += frameMs;
        }

        // èŠ‚æµåçš„éƒ¨åˆ†è¯†åˆ«ï¼ˆæ¯1200msä¸€æ¬¡ï¼‰
        const now = Date.now();
        if (!isAsrRequesting && now - lastPartialAt > 1200 && recordedFloat32.length > 0) {
          const totalLength = recordedFloat32.reduce((s, a) => s + a.length, 0);
          const merged = new Float32Array(totalLength);
          let offset = 0; for (const c of recordedFloat32) { merged.set(c, offset); offset += c.length; }
          lastPartialAt = now;
          requestASRPartial(audioContextRef, merged);
        }

        // é™éŸ³ç»“æŸåˆ¤å®š
        if (heardAnyVoice && accumulatedSilenceMs >= SILENCE_END_MS) {
          finalizeASR();
        }
      };

      async function finalizeASR() {
        if (!isListening) return;
        isListening = false;
        try { processorRef.disconnect(); sourceRef.disconnect(); } catch (e) {}

        // æ„é€ æœ€ç»ˆåˆå¹¶æ•°æ®
        const totalLength = recordedFloat32.reduce((s, a) => s + a.length, 0);
        const merged = new Float32Array(totalLength);
        let offset = 0; for (const c of recordedFloat32) { merged.set(c, offset); offset += c.length; }

        // æœ€ç»ˆè¯†åˆ«ä¸€æ¬¡ï¼Œè‹¥å¤±è´¥åˆ™ä½¿ç”¨ partial
        try {
          await requestASRPartial(audioContextRef, merged);
        } catch (e) {}

        voiceButton.className = 'btn voice-off';
        voiceButton.textContent = 'ğŸ¤ è¯­éŸ³';
        userInput.style.fontStyle = 'normal';
        userInput.style.opacity = '1';

        const finalText = lastPartialText && lastPartialText.trim();
        if (finalText) {
          const punct = restoreChinesePunctuation(finalText);
          userInput.value = punct;
          handleUserInput();
        } else {
          userInput.placeholder = 'æœªè¯†åˆ«åˆ°æœ‰æ•ˆè¯­éŸ³ï¼Œè¯·é‡è¯•';
        }
      }
    }

    // åœæ­¢è¯­éŸ³è¯†åˆ«
    function stopVoiceRecognition() {
      isListening = false;
      try { if (processorRef) processorRef.disconnect(); } catch (e) {}
      try { if (sourceRef) sourceRef.disconnect(); } catch (e) {}
      try { if (audioContextRef) audioContextRef.close(); } catch (e) {}
      processorRef = null; sourceRef = null; audioContextRef = null;
      recordedFloat32 = [];
      // å…³é—­éº¦å…‹é£
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
      voiceButton.className = 'btn voice-off';
      voiceButton.textContent = 'ğŸ¤ è¯­éŸ³';
      userInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
      userInput.style.fontStyle = 'normal';
      userInput.style.opacity = '1';
    }

    // åˆ‡æ¢è¯­éŸ³è¯†åˆ«çŠ¶æ€
    function toggleVoiceRecognition() {
      if (!voiceRecognitionSupported) {
        alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½');
        return;
      }

      console.log('åˆ‡æ¢è¯­éŸ³è¯†åˆ«çŠ¶æ€ï¼Œå½“å‰ï¼šenabled=', isVoiceEnabled, 'listening=', isListening);

      if (isVoiceEnabled) {
        // å…³é—­è¯­éŸ³è¯†åˆ«
        console.log('ç”¨æˆ·ä¸»åŠ¨å…³é—­è¯­éŸ³è¯†åˆ«');
        isVoiceEnabled = false;
        stopVoiceRecognition();
        
        // ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€
        voiceButton.className = 'btn voice-off';
        voiceButton.textContent = 'ğŸ¤ å¼€å§‹';
        userInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
        
        console.log('è¯­éŸ³è¯†åˆ«å·²å…³é—­');
      } else {
        // å¼€å¯è¯­éŸ³è¯†åˆ«
        console.log('ç”¨æˆ·ä¸»åŠ¨å¼€å¯è¯­éŸ³è¯†åˆ«');
        isVoiceEnabled = true;
        
        // é‡ç½®ç½‘ç»œé”™è¯¯è®¡æ•°
        if (speechRecognition) {
          speechRecognition._networkErrorCount = 0;
        }
        
        // ç«‹å³æ›´æ–°æŒ‰é’®çŠ¶æ€ä¸ºå‡†å¤‡ä¸­
        voiceButton.className = 'btn voice-off';
        voiceButton.textContent = 'ğŸ¤ å‡†å¤‡ä¸­...';
        userInput.placeholder = 'æ­£åœ¨å¯åŠ¨è¯­éŸ³è¯†åˆ«...';
        
        startVoiceRecognition();
        console.log('è¯­éŸ³è¯†åˆ«å¯åŠ¨ä¸­...');
      }
    }

    // æµ‹è¯•éº¦å…‹é£åŠŸèƒ½
    async function testMicrophone() {
      console.log('=== å¼€å§‹éº¦å…‹é£æµ‹è¯• ===');
      
      try {
        // 1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        console.log('1. æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ...');
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          console.error('æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®');
          return;
        }
        console.log('âœ“ æµè§ˆå™¨æ”¯æŒéº¦å…‹é£è®¿é—®');

        // 2. è¯·æ±‚éº¦å…‹é£æƒé™
        console.log('2. è¯·æ±‚éº¦å…‹é£æƒé™...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log('âœ“ éº¦å…‹é£æƒé™è·å–æˆåŠŸ');

        // 3. æ£€æŸ¥éŸ³é¢‘è½¨é“
        const audioTracks = stream.getAudioTracks();
        console.log('3. éŸ³é¢‘è½¨é“ä¿¡æ¯:', audioTracks);
        if (audioTracks.length === 0) {
          console.error('âœ— æ²¡æœ‰æ‰¾åˆ°éŸ³é¢‘è½¨é“');
          return;
        }
        console.log('âœ“ æ‰¾åˆ°', audioTracks.length, 'ä¸ªéŸ³é¢‘è½¨é“');

        // 4. æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ”¯æŒ
        console.log('4. æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ”¯æŒ...');
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
          console.log('âœ“ è¯­éŸ³è¯†åˆ«APIå¯ç”¨');
        } else {
          console.error('âœ— è¯­éŸ³è¯†åˆ«APIä¸å¯ç”¨');
        }

        // 5. æµ‹è¯•éŸ³é¢‘è¾“å…¥çº§åˆ«
        console.log('5. å¼€å§‹æµ‹è¯•éŸ³é¢‘è¾“å…¥çº§åˆ«ï¼ˆè¯·è¯´è¯ï¼‰...');
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;
        source.connect(analyser);

        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        let testCount = 0;
        const testInterval = setInterval(() => {
          analyser.getByteFrequencyData(dataArray);
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) {
            sum += dataArray[i];
          }
          const average = sum / bufferLength;
          
          console.log(`éŸ³é¢‘çº§åˆ«: ${average.toFixed(2)} ${average > 10 ? '(æ£€æµ‹åˆ°å£°éŸ³!)' : ''}`);
          
          testCount++;
          if (testCount >= 30) { // æµ‹è¯•3ç§’
            clearInterval(testInterval);
            stream.getTracks().forEach(track => track.stop());
            console.log('=== éº¦å…‹é£æµ‹è¯•å®Œæˆ ===');
          }
        }, 100);

      } catch (error) {
        console.error('éº¦å…‹é£æµ‹è¯•å¤±è´¥:', error);
        if (error.name === 'NotAllowedError') {
          console.error('éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®');
        } else if (error.name === 'NotFoundError') {
          console.error('æ²¡æœ‰æ‰¾åˆ°éº¦å…‹é£è®¾å¤‡');
        }
      }
    }

    // åœæ­¢è¯­éŸ³æ’­æ”¾ï¼ˆæœåŠ¡ç«¯/æµè§ˆå™¨ä¸¤ç§é€”å¾„éƒ½åœæ­¢ï¼‰
    function stopSpeaking() {
      // å–æ¶ˆWeb Speech
      if (speechSynthesis && speechSynthesis.speaking) {
        try { speechSynthesis.cancel(); } catch (e) {}
      }
      currentUtterance = null;

      // åœæ­¢æœåŠ¡ç«¯éŸ³é¢‘
      if (currentAudio) {
        try { currentAudio.pause(); } catch (e) {}
        currentAudio.src = '';
        currentAudio = null;
      }
      if (currentAudioUrl) {
        try { URL.revokeObjectURL(currentAudioUrl); } catch (e) {}
        currentAudioUrl = null;
      }
      isSpeaking = false;
    }

    // æ–‡å­—è½¬è¯­éŸ³æ’­æ”¾ï¼ˆåªä½¿ç”¨åç«¯ edge-ttsï¼Œé¿å…å¥³æ€§è¯­éŸ³æ··å…¥ï¼‰
    async function speakText(text) {
      const token = ++speakToken;
      stopSpeaking();

      // æ’­æ”¾è¯­éŸ³æ—¶æš‚åœè¯­éŸ³è¯†åˆ«ï¼Œé¿å…å›éŸ³å¹²æ‰°
      const wasListening = isListening;
      if (isVoiceEnabled && isListening) {
        stopVoiceRecognition();
      }

      // è¿‡æ»¤æ‰åŠ¨ä½œæè¿°ï¼Œåªæ’­æ”¾å¯¹è¯å†…å®¹
      const speechText = filterActionText(text);
      if (!speechText || speechText.trim().length === 0) {
        console.log('è¿‡æ»¤åæ— å†…å®¹å¯æ’­æ”¾');
        return;
      }

      // å‡†å¤‡è§†é¢‘çŠ¶æ€ï¼Œä½†ä¸ç«‹å³åˆ‡æ¢ï¼Œç­‰éŸ³é¢‘å¼€å§‹æ’­æ”¾æ—¶å†åˆ‡æ¢
      // æ³¨æ„ï¼šè§†é¢‘çŠ¶æ€åˆ¤æ–­ä½¿ç”¨åŸå§‹æ–‡æœ¬ï¼Œå› ä¸ºåŠ¨ä½œæè¿°å¯èƒ½å½±å“è¡¨æƒ…é€‰æ‹©
      const videoState = getVideoStateFromContent(text);
      console.log('å‡†å¤‡æ’­æ”¾è¯­éŸ³ï¼Œç›®æ ‡çŠ¶æ€:', videoState, 'æ’­æ”¾å†…å®¹:', speechText);

      // åªä½¿ç”¨åç«¯ TTS ç”Ÿæˆé«˜è´¨é‡ç”·å£°ï¼Œä¸å›é€€åˆ°æµè§ˆå™¨è¯­éŸ³
      try {
        console.log('è¯·æ±‚æœåŠ¡ç«¯TTS:', speechText);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
        
        const ttsResp = await fetch('http://localhost:3001/api/tts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: speechText }),
          signal: controller.signal
        });
        clearTimeout(timeoutId);

        if (ttsResp.ok) {
          console.log('æœåŠ¡ç«¯TTSå“åº”æˆåŠŸ');
          const audioBlob = await ttsResp.blob();
          const audioUrl = URL.createObjectURL(audioBlob);
          const audio = new Audio(audioUrl);
          
          // è®¾ç½®éŸ³é¢‘å±æ€§
          audio.preload = 'auto';
          audio.volume = 0.9;
          
          currentAudio = audio;
          currentAudioUrl = audioUrl;
          isSpeaking = true;

          audio.onloadstart = () => {
            console.log('éŸ³é¢‘å¼€å§‹åŠ è½½');
          };

          audio.oncanplay = () => {
            console.log('éŸ³é¢‘å¯ä»¥æ’­æ”¾');
          };

          audio.onplay = () => {
              console.log('éŸ³é¢‘å¼€å§‹æ’­æ”¾ï¼Œåˆ‡æ¢è§†é¢‘çŠ¶æ€åˆ°:', videoState, 'token:', token, 'speakToken:', speakToken);
              if (token === speakToken) {
                // åªåœ¨éŸ³é¢‘çœŸæ­£å¼€å§‹æ’­æ”¾æ—¶åˆ‡æ¢è§†é¢‘çŠ¶æ€
                isSpeaking = true; // ç¡®ä¿è®¾ç½®è¯´è¯çŠ¶æ€
                // å¼ºåˆ¶åˆ‡æ¢åˆ°è¯´è¯çŠ¶æ€ï¼Œç»•è¿‡shouldAllowVideoStateChangeæ£€æŸ¥
                forceChangeVideoState(videoState);
                statusIndicator.textContent = customStatusTexts.speaking;
                statusIndicator.className = 'status-speaking';
              } else {
                console.log('éŸ³é¢‘tokenä¸åŒ¹é…ï¼Œè·³è¿‡è§†é¢‘åˆ‡æ¢');
              }
          };

          audio.onended = () => {
            console.log('éŸ³é¢‘æ’­æ”¾ç»“æŸï¼Œtoken:', token, 'speakToken:', speakToken);
            if (token === speakToken) {
              console.log('éŸ³é¢‘æ’­æ”¾ç»“æŸï¼Œåˆ‡æ¢å›é™æ­¢çŠ¶æ€');
              isSpeaking = false;
              try { URL.revokeObjectURL(audioUrl); } catch (e) {}
              currentAudio = null; 
              currentAudioUrl = null;
              statusIndicator.textContent = customStatusTexts.idle;
              statusIndicator.className = 'status-idle';
              // é‡ç½®é™æ­¢æ’­æ”¾è®¡æ•°å™¨ï¼Œé‡æ–°å¼€å§‹å¾ªç¯
              stillVideoPlayCount = 0;
              changeVideoState('still');
              
              // è¯­éŸ³æ’­æ”¾ç»“æŸåï¼Œå¦‚æœè¯­éŸ³è¯†åˆ«åŠŸèƒ½å¼€å¯ï¼Œè‡ªåŠ¨æ¢å¤ç›‘å¬
              if (isVoiceEnabled && !isListening) {
                setTimeout(() => {
                  if (isVoiceEnabled && !isSpeaking) {
                    startVoiceRecognition();
                  }
                }, 1000); // å»¶è¿Ÿ1ç§’å†å¼€å§‹ç›‘å¬ï¼Œé¿å…æ®‹ç•™å£°éŸ³å¹²æ‰°
              }
            }
          };

          audio.onerror = (e) => {
            console.error('éŸ³é¢‘æ’­æ”¾é”™è¯¯:', e);
            if (token === speakToken) {
              isSpeaking = false;
              try { URL.revokeObjectURL(audioUrl); } catch (e) {}
              currentAudio = null;
              currentAudioUrl = null;
              // æ’­æ”¾å¤±è´¥æ—¶ä¹Ÿå›åˆ°å¾…æœºçŠ¶æ€
              statusIndicator.textContent = customStatusTexts.idle;
              statusIndicator.className = 'status-idle';
              // é‡ç½®é™æ­¢æ’­æ”¾è®¡æ•°å™¨
              stillVideoPlayCount = 0;
              changeVideoState('still');
              
              // æ’­æ”¾å¤±è´¥æ—¶ä¹Ÿæ¢å¤è¯­éŸ³è¯†åˆ«
              if (isVoiceEnabled && !isListening) {
                setTimeout(() => {
                  if (isVoiceEnabled && !isSpeaking) {
                    startVoiceRecognition();
                  }
                }, 500);
              }
            }
          };

          // å¼€å§‹æ’­æ”¾
          await audio.play();
          console.log('éŸ³é¢‘æ’­æ”¾å‘½ä»¤å·²æ‰§è¡Œ');
          return;
        } else {
          console.error('æœåŠ¡ç«¯TTSå“åº”å¤±è´¥:', ttsResp.status);
        }
      } catch (err) {
        console.error('æœåŠ¡ç«¯TTSè¯·æ±‚å¤±è´¥:', err);
      }

      // å¦‚æœæœåŠ¡ç«¯TTSå¤±è´¥ï¼Œç›´æ¥å›åˆ°å¾…æœºçŠ¶æ€ï¼Œä¸ä½¿ç”¨æµè§ˆå™¨è¯­éŸ³
      console.log('TTSå¤±è´¥ï¼Œä¿æŒå¾…æœºçŠ¶æ€');
      if (token === speakToken) {
        isSpeaking = false;
        statusIndicator.textContent = 'å¾…æœºä¸­';
        statusIndicator.className = 'status-idle';
        // TTSå¤±è´¥æ—¶ä¸åˆ‡æ¢è§†é¢‘ï¼Œä¿æŒå½“å‰çŠ¶æ€
      }
    }

    // Web Speech å›é€€å‡½æ•°å·²ç§»é™¤ï¼Œåªä½¿ç”¨æœåŠ¡ç«¯ edge-tts

    // åº”ç”¨çŠ¶æ€
    let currentVideoIsMain = true; // trueè¡¨ç¤ºä¸»è§†é¢‘åœ¨å‰ï¼Œfalseè¡¨ç¤ºå¤‡ç”¨è§†é¢‘åœ¨å‰
    
    // æ£€æŸ¥æ˜¯å¦åº”è¯¥å…è®¸è§†é¢‘çŠ¶æ€åˆ‡æ¢
    function shouldAllowVideoStateChange(newState) {
      console.log('æ£€æŸ¥è§†é¢‘çŠ¶æ€åˆ‡æ¢ - ç›®æ ‡çŠ¶æ€:', newState, 'isSpeaking:', isSpeaking, 'isProcessing:', isProcessing, 'currentState:', currentState);
      
      // å¦‚æœæ­£åœ¨è¯´è¯ï¼Œåªå…è®¸åˆ‡æ¢åˆ°è¯´è¯çŠ¶æ€
      if (isSpeaking && (newState === 'still' || newState === 'calm')) {
        console.log('æ‹’ç»åˆ‡æ¢ï¼šæ­£åœ¨è¯´è¯æ—¶ä¸èƒ½åˆ‡æ¢åˆ°é™æ­¢çŠ¶æ€');
        return false;
      }
      
      // å¦‚æœä¸åœ¨è¯´è¯çŠ¶æ€ï¼Œä¸å…è®¸åˆ‡æ¢åˆ°è¯´è¯çŠ¶æ€ï¼ˆé™¤éæ˜¯çœŸæ­£çš„éŸ³é¢‘æ’­æ”¾è§¦å‘ï¼‰
      if (!isSpeaking && (newState === 'serious' || newState === 'smile')) {
        console.log('æ‹’ç»åˆ‡æ¢ï¼šä¸åœ¨è¯´è¯çŠ¶æ€æ—¶ä¸èƒ½åˆ‡æ¢åˆ°è¯´è¯çŠ¶æ€');
        return false;
      }
      
      // å¦‚æœæ­£åœ¨å¤„ç†è¯·æ±‚ï¼Œä¸å…è®¸å®šæ—¶å™¨åˆ‡æ¢
      if (isProcessing && (newState === 'calm' || newState === 'still')) {
        console.log('æ‹’ç»åˆ‡æ¢ï¼šæ­£åœ¨å¤„ç†è¯·æ±‚æ—¶ä¸å…è®¸å®šæ—¶å™¨åˆ‡æ¢');
        return false;
      }
      
      return true;
    }

    // å¼ºåˆ¶åˆ‡æ¢è§†é¢‘çŠ¶æ€ï¼ˆç»•è¿‡å®‰å…¨æ£€æŸ¥ï¼Œç”¨äºéŸ³é¢‘æ’­æ”¾æ—¶ï¼‰
    function forceChangeVideoState(state) {
      console.log('å¼ºåˆ¶åˆ‡æ¢è§†é¢‘çŠ¶æ€åˆ°:', state);
      executeVideoStateChange(state);
    }

    // åˆ‡æ¢æ•°å­—äººçŠ¶æ€è§†é¢‘ï¼ˆåŒè§†é¢‘äº¤å‰æ·¡å…¥æ·¡å‡ºï¼‰
    function changeVideoState(state) {
      // æ£€æŸ¥æ˜¯å¦åº”è¯¥å…è®¸åˆ‡æ¢
      if (!shouldAllowVideoStateChange(state)) {
        return;
      }
      
      executeVideoStateChange(state);
    }
    
    // æ‰§è¡Œå®é™…çš„è§†é¢‘çŠ¶æ€åˆ‡æ¢
    function executeVideoStateChange(state) {
      let videoPath = '';
      let statusText = '';
      let statusClass = '';
      
      console.log('æ‰§è¡Œè§†é¢‘çŠ¶æ€åˆ‡æ¢åˆ°:', state, 'è°ƒç”¨æ ˆ:', new Error().stack.split('\n')[1]);
      
      switch(state) {
        case 'still':
          videoPath = '/shucai/é™æ­¢.mp4';
          statusText = customStatusTexts.idle;
          statusClass = 'status-idle';
          currentState = 'idle';
          isInCalmState = false;
          break;
        case 'calm':
          videoPath = '/shucai/å¹³é™é™æ­¢çŠ¶æ€.mp4';
          statusText = customStatusTexts.idle;
          statusClass = 'status-idle';
          currentState = 'idle';
          isInCalmState = true;
          break;
        case 'serious':
          videoPath = '/shucai/ä¸¥è‚ƒè¯´è¯.mp4';
          statusText = customStatusTexts.speaking;
          statusClass = 'status-speaking';
          currentState = 'speaking';
          isInCalmState = false;
          break;
        case 'smile':
          videoPath = '/shucai/å¾®ç¬‘è¯´è¯.mp4';
          statusText = customStatusTexts.speaking;
          statusClass = 'status-speaking';
          currentState = 'speaking';
          isInCalmState = false;
          break;
        default:
          videoPath = '/shucai/é™æ­¢.mp4';
          statusText = customStatusTexts.idle;
          statusClass = 'status-idle';
          currentState = 'idle';
          isInCalmState = false;
      }
      
      // è·å–å½“å‰æ˜¾ç¤ºçš„è§†é¢‘å’Œéšè—çš„è§†é¢‘
      const currentVideo = currentVideoIsMain ? videoElement : videoElementAlt;
      const nextVideo = currentVideoIsMain ? videoElementAlt : videoElement;
      
      // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢
      const currentPath = currentVideo.src;
      const newPath = new URL(videoPath, window.location.href).href;
      if (currentPath === newPath) {
        console.log('è§†é¢‘çŠ¶æ€ç›¸åŒï¼Œæ— éœ€åˆ‡æ¢');
        return;
      }
      
      console.log('å¼€å§‹äº¤å‰æ·¡å…¥æ·¡å‡ºåˆ‡æ¢');
      
      // è®¾ç½®ä¸‹ä¸€ä¸ªè§†é¢‘
      nextVideo.src = videoPath;
      nextVideo.load();
      
      // å½“ä¸‹ä¸€ä¸ªè§†é¢‘å‡†å¤‡å¥½æ—¶å¼€å§‹åˆ‡æ¢
      nextVideo.oncanplay = () => {
        nextVideo.play().then(() => {
          // å¼€å§‹äº¤å‰æ·¡å…¥æ·¡å‡ºåŠ¨ç”»
          nextVideo.style.transition = 'opacity 0.6s ease-in-out';
          currentVideo.style.transition = 'opacity 0.6s ease-in-out';
          
          // æ·¡å…¥æ–°è§†é¢‘ï¼Œæ·¡å‡ºæ—§è§†é¢‘
          nextVideo.style.opacity = '1';
          currentVideo.style.opacity = '0';
          
          // åŠ¨ç”»å®Œæˆåäº¤æ¢è§†é¢‘è§’è‰²
          setTimeout(() => {
            currentVideoIsMain = !currentVideoIsMain;
            
            // æ¸…ç†è¿‡æ¸¡æ•ˆæœ
            nextVideo.style.transition = '';
            currentVideo.style.transition = '';
            
            console.log('è§†é¢‘åˆ‡æ¢å®Œæˆ');
          }, 600);
          
        }).catch(e => {
          console.warn('æ–°è§†é¢‘æ’­æ”¾å¤±è´¥:', e);
        });
      };
      
      nextVideo.onerror = () => {
        console.error('æ–°è§†é¢‘åŠ è½½å¤±è´¥:', videoPath);
      };
      
      // ç«‹å³æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      statusIndicator.textContent = statusText;
      statusIndicator.className = statusClass;
      
      // ç®¡ç†é™æ­¢çŠ¶æ€å®šæ—¶å™¨
      manageIdleTimer(state);
    }

    // ç®¡ç†é™æ­¢çŠ¶æ€å®šæ—¶å™¨
    function manageIdleTimer(state) {
      console.log('ç®¡ç†å®šæ—¶å™¨ - çŠ¶æ€:', state, 'isSpeaking:', isSpeaking, 'é™æ­¢æ’­æ”¾æ¬¡æ•°:', stillVideoPlayCount);
      
      // æ¸…é™¤ç°æœ‰å®šæ—¶å™¨
      if (idleTimer) {
        clearTimeout(idleTimer);
        idleTimer = null;
        console.log('æ¸…é™¤ç°æœ‰å®šæ—¶å™¨');
      }
      
      // å¦‚æœæ˜¯è¯´è¯çŠ¶æ€ï¼Œä¸å¯åŠ¨å®šæ—¶å™¨ï¼Œé‡ç½®è®¡æ•°å™¨
      if (state === 'serious' || state === 'smile') {
        console.log('è¯´è¯çŠ¶æ€ï¼Œä¸å¯åŠ¨å®šæ—¶å™¨ï¼Œé‡ç½®è®¡æ•°å™¨');
        stillVideoPlayCount = 0;
        return;
      }
      
      // å¦‚æœæ˜¯é™æ­¢çŠ¶æ€ï¼Œå¯åŠ¨å®šæ—¶å™¨
      if (state === 'still' || state === 'calm') {
        console.log('å¯åŠ¨é™æ­¢çŠ¶æ€å®šæ—¶å™¨');
        
        // æ ¹æ®å½“å‰çŠ¶æ€è®¾ç½®è®¡æ•°å™¨
        if (state === 'still' && !isInCalmState) {
          stillVideoPlayCount = 1; // åˆšåˆ‡æ¢åˆ°é™æ­¢çŠ¶æ€ï¼Œå¼€å§‹è®¡æ•°
          console.log('å¼€å§‹é™æ­¢çŠ¶æ€å¾ªç¯ï¼Œå½“å‰æ’­æ”¾æ¬¡æ•°:', stillVideoPlayCount);
        } else if (state === 'calm') {
          console.log('åˆ‡æ¢åˆ°å¹³é™çŠ¶æ€ï¼Œå‡†å¤‡æ’­æ”¾1æ¬¡');
        }
        
        // å¯åŠ¨åŸºäºè§†é¢‘æ’­æ”¾å‘¨æœŸçš„å®šæ—¶å™¨
        function scheduleNextSwitch() {
          idleTimer = setTimeout(() => {
            console.log('å®šæ—¶å™¨è§¦å‘ - isSpeaking:', isSpeaking, 'currentState:', currentState, 'isInCalmState:', isInCalmState, 'isProcessing:', isProcessing, 'é™æ­¢æ’­æ”¾æ¬¡æ•°:', stillVideoPlayCount);
            
            // åªæœ‰åœ¨å®Œå…¨ç©ºé—²çŠ¶æ€ä¸‹æ‰åˆ‡æ¢
            if (!isSpeaking && !isProcessing && currentState === 'idle') {
              if (isInCalmState) {
                // å¦‚æœå½“å‰æ˜¯å¹³é™çŠ¶æ€ï¼Œæ’­æ”¾å®Œæ¯•ååˆ‡æ¢å›é™æ­¢çŠ¶æ€ï¼Œé‡ç½®è®¡æ•°å™¨
                console.log('å®šæ—¶å™¨ï¼šå¹³é™çŠ¶æ€æ’­æ”¾å®Œæ¯•ï¼Œåˆ‡æ¢å›é™æ­¢çŠ¶æ€');
                stillVideoPlayCount = 1; // é‡æ–°å¼€å§‹é™æ­¢çŠ¶æ€è®¡æ•°
                changeVideoState('still');
                scheduleNextSwitch();
              } else {
                // å¦‚æœå½“å‰æ˜¯é™æ­¢çŠ¶æ€
                if (stillVideoPlayCount < 5) {
                  // è¿˜æ²¡æ’­æ”¾å¤Ÿ5æ¬¡ï¼Œç»§ç»­æ’­æ”¾é™æ­¢çŠ¶æ€
                  stillVideoPlayCount++;
                  console.log('å®šæ—¶å™¨ï¼šç»§ç»­æ’­æ”¾é™æ­¢çŠ¶æ€ï¼Œå½“å‰æ¬¡æ•°:', stillVideoPlayCount);
                  // ä¸éœ€è¦åˆ‡æ¢è§†é¢‘ï¼Œåªæ˜¯è®©å®ƒç»§ç»­å¾ªç¯æ’­æ”¾
                  scheduleNextSwitch();
                } else {
                  // å·²ç»æ’­æ”¾äº†5æ¬¡é™æ­¢çŠ¶æ€ï¼Œåˆ‡æ¢åˆ°å¹³é™çŠ¶æ€
                  console.log('å®šæ—¶å™¨ï¼šé™æ­¢çŠ¶æ€å·²æ’­æ”¾5æ¬¡ï¼Œåˆ‡æ¢åˆ°å¹³é™çŠ¶æ€');
                  stillVideoPlayCount = 0; // é‡ç½®è®¡æ•°å™¨
                  changeVideoState('calm');
                  scheduleNextSwitch();
                }
              }
            } else {
              console.log('å®šæ—¶å™¨ï¼šè·³è¿‡åˆ‡æ¢ - isSpeaking:', isSpeaking, 'isProcessing:', isProcessing, 'currentState:', currentState);
              // å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œ1ç§’åå†æ£€æŸ¥
              idleTimer = setTimeout(() => {
                scheduleNextSwitch();
              }, 1000);
            }
          }, 20000); // 20ç§’ï¼Œç¡®ä¿18ç§’è§†é¢‘æ’­æ”¾å®Œæ•´
        }
        
        scheduleNextSwitch();
      }
    }

    // è¿‡æ»¤æ–‡æœ¬ä¸­çš„åŠ¨ä½œæè¿°
    function filterActionText(text) {
      if (!text) return text;
      
      // ç§»é™¤å„ç§æ‹¬å·å†…çš„åŠ¨ä½œæè¿°
      let filteredText = text
        .replace(/ï¼ˆ[^ï¼‰]*ï¼‰/g, '')  // ä¸­æ–‡åœ†æ‹¬å·
        .replace(/\([^)]*\)/g, '')   // è‹±æ–‡åœ†æ‹¬å·
        .replace(/ã€[^ã€‘]*ã€‘/g, '')   // ä¸­æ–‡æ–¹æ‹¬å·
        .replace(/\[[^\]]*\]/g, '')  // è‹±æ–‡æ–¹æ‹¬å·
        .replace(/ã€Œ[^ã€]*ã€/g, '')   // ä¸­æ–‡ä¹¦åå·
        .replace(/ã€[^ã€]*ã€/g, '')   // ä¸­æ–‡åŒä¹¦åå·
        .replace(/\*[^*]*\*/g, '')   // æ˜Ÿå·åŒ…å›´çš„åŠ¨ä½œ
        .replace(/_[^_]*_/g, '')     // ä¸‹åˆ’çº¿åŒ…å›´çš„åŠ¨ä½œ
        .trim();                     // å»é™¤é¦–å°¾ç©ºç™½
      
      // å»é™¤å¤šä½™çš„ç©ºæ ¼
      filteredText = filteredText.replace(/\s+/g, ' ').trim();
      
      console.log('åŸæ–‡æœ¬:', text);
      console.log('è¿‡æ»¤å:', filteredText);
      
      return filteredText;
    }

    // æ·»åŠ æ¶ˆæ¯åˆ°å¯¹è¯å†å²
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
      
      const headerDiv = document.createElement('div');
      headerDiv.className = 'message-header';
      headerDiv.textContent = isUser ? 'ç”¨æˆ·' : 'æ›¹æ“';
      
      const contentDiv = document.createElement('div');
      // å¯¹AIå›å¤è¿›è¡ŒåŠ¨ä½œæ–‡æœ¬è¿‡æ»¤
      const displayText = isUser ? content : filterActionText(content);
      contentDiv.textContent = displayText;
      
      messageDiv.appendChild(headerDiv);
      messageDiv.appendChild(contentDiv);
      chatHistory.appendChild(messageDiv);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // æ ¹æ®å†…å®¹åˆ¤æ–­åº”è¯¥ä½¿ç”¨çš„è§†é¢‘çŠ¶æ€
    function getVideoStateFromContent(content) {
      console.log('åˆ†æå†…å®¹:', content);
      
      // ä¸¥è‚ƒè¯é¢˜å…³é”®è¯
      const seriousKeywords = [
        'ä¸¥è‚ƒ', 'é‡è¦', 'æˆ˜äº‰', 'æ”¿æ²»', 'å†›äº‹', 'æ²»å›½', 'å¤©ä¸‹', 'ç»Ÿä¸€', 'å¾æˆ˜',
        'ç­–ç•¥', 'å†³æ–­', 'å¨ä¸¥', 'éœ¸ä¸š', 'æƒè°‹', 'æœå»·', 'æ•Œäºº', 'æˆ˜ç•¥',
        'æŠ±æ­‰', 'æ— æ³•', 'é”™è¯¯', 'å¤±è´¥', 'é—®é¢˜', 'å›°éš¾', 'æŒ‘æˆ˜', 'å±é™©'
      ];
      
      // å¾®ç¬‘è¯é¢˜å…³é”®è¯  
      const smileKeywords = [
        'å¥½', 'æ‚¨å¥½', 'è°¢è°¢', 'å¼€å¿ƒ', 'é«˜å…´', 'æ¬¢è¿', 'å¾ˆå¥½', 'ä¸é”™', 'ä¼˜ç§€',
        'èµ', 'æ£’', 'æˆåŠŸ', 'èƒœåˆ©', 'å–œæ¬¢', 'æ»¡æ„', 'æ„‰å¿«', 'å¿«ä¹', 'å¹¸ç¦',
        'è§åˆ°æ‚¨', 'è®¨è®º', 'äº¤æµ', 'åˆ†äº«', 'æœ‰è¶£', 'ç²¾å½©', 'wonderful'
      ];
      
      // æ£€æŸ¥ä¸¥è‚ƒå…³é”®è¯
      for (let keyword of seriousKeywords) {
        if (content.includes(keyword)) {
          console.log('æ£€æµ‹åˆ°ä¸¥è‚ƒå…³é”®è¯:', keyword);
          return 'serious';
        }
      }
      
      // æ£€æŸ¥å¾®ç¬‘å…³é”®è¯
      for (let keyword of smileKeywords) {
        if (content.includes(keyword)) {
          console.log('æ£€æµ‹åˆ°å¾®ç¬‘å…³é”®è¯:', keyword);
          return 'smile';
        }
      }
      
      console.log('ä½¿ç”¨é»˜è®¤å¾®ç¬‘çŠ¶æ€');
      // é»˜è®¤ä½¿ç”¨å¾®ç¬‘çŠ¶æ€ï¼ˆæ›´å‹å¥½ï¼‰
      return 'smile';
    }

    // è°ƒç”¨åç«¯APIè·å–AIå›å¤
    async function getAIResponse(userMessage) {
      try {
        const response = await fetch('http://localhost:3001/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ message: userMessage })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('APIå›å¤æ¥æº:', data.source);
        return data.response;
        
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›é»˜è®¤å›å¤
        return 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ–è€…ç¨åå†è¯•ã€‚';
      }
    }

    // å¤„ç†ç”¨æˆ·è¾“å…¥
    async function handleUserInput() {
      const message = userInput.value.trim();
      if (!message || isProcessing) return;

      // ä»»ä½•æ–°è¾“å…¥éƒ½ç«‹å³æ‰“æ–­å½“å‰è¯­éŸ³ä¸æ€è€ƒï¼Œä¿è¯åªè¯´æœ€æ–°
      stopSpeaking();

      isProcessing = true;
      sendButton.disabled = true;
      sendButton.textContent = 'å‘é€ä¸­...';

      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      addMessage(message, true);
      userInput.value = '';

      // è®¾ç½®æ€è€ƒçŠ¶æ€ï¼ˆä¸çŠ¶æ€æŒ‡ç¤ºå™¨åŒæ­¥ï¼‰
      statusIndicator.textContent = customStatusTexts.thinking;
      statusIndicator.className = 'status-thinking';

      try {
        // è·å–AIå›å¤
        const aiResponse = await getAIResponse(message);

        // æ·»åŠ AIå›å¤å¹¶å‘å£°ï¼ˆè§†é¢‘åˆ‡æ¢ç”±speakTextå‡½æ•°åœ¨éŸ³é¢‘æ’­æ”¾æ—¶å¤„ç†ï¼‰
        addMessage(aiResponse);
        speakText(aiResponse);

      } catch (error) {
        console.error('å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™:', error);
        const errorMessage = 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚';
        addMessage(errorMessage);
        speakText(errorMessage);
      }

      isProcessing = false;
      sendButton.disabled = false;
      sendButton.textContent = 'å‘é€';
    }

    // æ‰“æ–­åŠŸèƒ½
    function handleInterrupt() {
      // åœæ­¢è¯­éŸ³æ’­æ”¾å¹¶å›å¾…æœº
      stopSpeaking();
      // é‡ç½®é™æ­¢æ’­æ”¾è®¡æ•°å™¨
      stillVideoPlayCount = 0;
      changeVideoState('still');
      addMessage('å¯¹è¯å·²è¢«æ‰“æ–­ï¼Œæˆ‘å·²å›åˆ°å¾…æœºçŠ¶æ€ã€‚');

      // å¦‚æœæ­£åœ¨å¤„ç†ï¼Œåˆ™åœæ­¢å¤„ç†
      if (isProcessing) {
        isProcessing = false;
        sendButton.disabled = false;
        sendButton.textContent = 'å‘é€';
      }

      // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
      statusIndicator.textContent = customStatusTexts.idle;
      statusIndicator.className = 'status-idle';
    }

    // è®¾ç½®åŠŸèƒ½ï¼ˆä½¿ç”¨è‡ªå®šä¹‰å¯¹è¯æ¡†ï¼‰
    async function handleSettings() {
      console.log('è®¾ç½®æŒ‰é’®è¢«ç‚¹å‡»');
      try {
        const password = await showCustomPrompt('è®¾ç½®å¯†ç ', 'è¯·è¾“å…¥è®¾ç½®å¯†ç ï¼š');
        console.log('ç”¨æˆ·è¾“å…¥çš„å¯†ç :', password);
        if (password === '123456') { // ä¸´æ—¶å¯†ç 
        const options = [
          'æµ‹è¯•éº¦å…‹é£åŠŸèƒ½',
          'é‡æ–°åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«',
          'æŸ¥çœ‹è¯­éŸ³è¯†åˆ«çŠ¶æ€',
          'é‡ç½®ç½‘ç»œé”™è¯¯è®¡æ•°',
          'è‡ªå®šä¹‰çŠ¶æ€æŒ‡ç¤ºå™¨æ–‡æœ¬',
          'å…¶ä»–è®¾ç½®ï¼ˆå¼€å‘ä¸­ï¼‰'
        ];
        
        const choice = await showCustomSelect('è®¾ç½®èœå•', 'è¯·é€‰æ‹©åŠŸèƒ½ï¼š', options);
        
        switch(choice) {
          case '1':
            testMicrophone();
            alert('éº¦å…‹é£æµ‹è¯•å·²å¼€å§‹ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º');
            break;
          case '2':
            initializeSpeechRecognition();
            alert('è¯­éŸ³è¯†åˆ«å·²é‡æ–°åˆå§‹åŒ–');
            break;
          case '3':
            const status = {
              supported: voiceRecognitionSupported,
              enabled: isVoiceEnabled,
              listening: isListening,
              speechRecognition: !!speechRecognition,
              networkErrorCount: speechRecognition?._networkErrorCount || 0
            };
            console.log('è¯­éŸ³è¯†åˆ«çŠ¶æ€:', status);
            alert(`è¯­éŸ³è¯†åˆ«çŠ¶æ€ï¼š
æ”¯æŒ: ${status.supported}
å¯ç”¨: ${status.enabled}
ç›‘å¬ä¸­: ${status.listening}
ç½‘ç»œé”™è¯¯æ¬¡æ•°: ${status.networkErrorCount}`);
            break;
          case '4':
            if (speechRecognition) {
              speechRecognition._networkErrorCount = 0;
              console.log('ç½‘ç»œé”™è¯¯è®¡æ•°å·²é‡ç½®');
              alert('ç½‘ç»œé”™è¯¯è®¡æ•°å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å°è¯•è¯­éŸ³åŠŸèƒ½');
              
              // é‡ç½®æŒ‰é’®çŠ¶æ€
              if (!isVoiceEnabled) {
                voiceButton.textContent = 'ğŸ¤ å¼€å§‹';
                userInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
              }
            }
            break;
          case '5':
            const statusOptions = [
              'å¾…æœºçŠ¶æ€æ–‡æœ¬ (å½“å‰: ' + customStatusTexts.idle + ')',
              'æ€è€ƒçŠ¶æ€æ–‡æœ¬ (å½“å‰: ' + customStatusTexts.thinking + ')',
              'å¯¹è¯çŠ¶æ€æ–‡æœ¬ (å½“å‰: ' + customStatusTexts.speaking + ')',
              'è†å¬çŠ¶æ€æ–‡æœ¬ (å½“å‰: ' + customStatusTexts.listening + ')',
              'æ¢å¤é»˜è®¤æ–‡æœ¬'
            ];
            
            const statusChoice = await showCustomSelect('çŠ¶æ€æ–‡æœ¬è®¾ç½®', 'é€‰æ‹©è¦ä¿®æ”¹çš„çŠ¶æ€æ–‡æœ¬ï¼š', statusOptions);
            
            switch(statusChoice) {
              case '1':
                const newIdleText = await showCustomPrompt('ä¿®æ”¹å¾…æœºçŠ¶æ€', 'è¯·è¾“å…¥æ–°çš„å¾…æœºçŠ¶æ€æ–‡æœ¬ï¼š', customStatusTexts.idle);
                if (newIdleText && newIdleText.trim()) {
                  customStatusTexts.idle = newIdleText.trim();
                  if (currentState === 'idle') {
                    statusIndicator.textContent = customStatusTexts.idle;
                  }
                  alert('å¾…æœºçŠ¶æ€æ–‡æœ¬å·²æ›´æ–°');
                }
                break;
              case '2':
                const newThinkingText = await showCustomPrompt('ä¿®æ”¹æ€è€ƒçŠ¶æ€', 'è¯·è¾“å…¥æ–°çš„æ€è€ƒçŠ¶æ€æ–‡æœ¬ï¼š', customStatusTexts.thinking);
                if (newThinkingText && newThinkingText.trim()) {
                  customStatusTexts.thinking = newThinkingText.trim();
                  alert('æ€è€ƒçŠ¶æ€æ–‡æœ¬å·²æ›´æ–°');
                }
                break;
              case '3':
                const newSpeakingText = await showCustomPrompt('ä¿®æ”¹å¯¹è¯çŠ¶æ€', 'è¯·è¾“å…¥æ–°çš„å¯¹è¯çŠ¶æ€æ–‡æœ¬ï¼š', customStatusTexts.speaking);
                if (newSpeakingText && newSpeakingText.trim()) {
                  customStatusTexts.speaking = newSpeakingText.trim();
                  alert('å¯¹è¯çŠ¶æ€æ–‡æœ¬å·²æ›´æ–°');
                }
                break;
              case '4':
                const newListeningText = await showCustomPrompt('ä¿®æ”¹è†å¬çŠ¶æ€', 'è¯·è¾“å…¥æ–°çš„è†å¬çŠ¶æ€æ–‡æœ¬ï¼š', customStatusTexts.listening);
                if (newListeningText && newListeningText.trim()) {
                  customStatusTexts.listening = newListeningText.trim();
                  alert('è†å¬çŠ¶æ€æ–‡æœ¬å·²æ›´æ–°');
                }
                break;
              case '5':
                customStatusTexts = {
                  idle: 'å¾…æœºä¸­',
                  thinking: 'æ€è€ƒä¸­',
                  speaking: 'å¯¹è¯ä¸­',
                  listening: 'è†å¬ä¸­'
                };
                statusIndicator.textContent = customStatusTexts[currentState] || customStatusTexts.idle;
                alert('çŠ¶æ€æ–‡æœ¬å·²æ¢å¤é»˜è®¤');
                break;
            }
            break;
          default:
            alert('è®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
        }
        } else if (password) {
          alert('å¯†ç é”™è¯¯ï¼');
        }
      } catch (error) {
        console.error('è®¾ç½®åŠŸèƒ½å‡ºé”™:', error);
        alert('è®¾ç½®åŠŸèƒ½å‡ºç°é”™è¯¯: ' + error.message);
      }
    }

    // äº‹ä»¶ç›‘å¬å™¨
    console.log('ç»‘å®šäº‹ä»¶ç›‘å¬å™¨...');
    console.log('è®¾ç½®æŒ‰é’®å…ƒç´ :', settingsButton);
    console.log('è®¾ç½®æŒ‰é’®æ˜¯å¦å­˜åœ¨:', !!settingsButton);
    
    sendButton.addEventListener('click', handleUserInput);
    voiceButton.addEventListener('click', toggleVoiceRecognition);
    interruptButton.addEventListener('click', handleInterrupt);
    
    if (settingsButton) {
      settingsButton.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘');
        handleSettings();
      });
      console.log('è®¾ç½®æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²ç»‘å®š');
    } else {
      console.error('è®¾ç½®æŒ‰é’®æœªæ‰¾åˆ°ï¼');
    }
    statusIndicator.addEventListener('click', async () => {
      console.log('çŠ¶æ€æŒ‡ç¤ºå™¨è¢«ç‚¹å‡»');
      const newText = await showCustomPrompt('ä¿®æ”¹çŠ¶æ€æ–‡æœ¬', 'è¯·è¾“å…¥æ–°çš„çŠ¶æ€æ–‡æœ¬ï¼š', statusIndicator.textContent);
      if (newText && newText.trim()) {
        statusIndicator.textContent = newText.trim();
        // åŒæ—¶æ›´æ–°å¯¹åº”çš„è‡ªå®šä¹‰æ–‡æœ¬
        customStatusTexts[currentState] = newText.trim();
      }
    });
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
    userInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleUserInput();
      }
    });
    
    // æ·»åŠ å…¨å±€é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + M åˆ‡æ¢è¯­éŸ³è¯†åˆ«
      if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
        e.preventDefault();
        toggleVoiceRecognition();
      }
      // Escape é”®ä¸­æ–­å½“å‰æ’­æ”¾
      if (e.key === 'Escape') {
        e.preventDefault();
        handleInterrupt();
      }
    });


    // åˆå§‹åŒ–
    console.log('æ•°å­—äººç³»ç»Ÿå·²å¯åŠ¨');
    
    // è®¾ç½®åˆå§‹çŠ¶æ€
    statusIndicator.textContent = customStatusTexts.idle;
    statusIndicator.className = 'status-idle';
    currentState = 'idle';
    
    // å°†å‡½æ•°æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
    window.handleSettings = handleSettings;
    
    // åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å‡½æ•°
    window.testSettings = function() {
      alert('æµ‹è¯•è®¾ç½®åŠŸèƒ½');
      handleSettings();
    };
    
    // åˆå§‹åŒ–æ–‡å­—è½¬è¯­éŸ³åŠŸèƒ½
    initializeTTS();
    
    // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«åŠŸèƒ½
    initializeSpeechRecognition();
    
    // å¯åŠ¨é™æ­¢çŠ¶æ€å®šæ—¶å™¨
    stillVideoPlayCount = 0; // åˆå§‹åŒ–è®¡æ•°å™¨
    changeVideoState('still');
    
    // æ¬¢è¿è¯­éŸ³ï¼ˆå»¶è¿Ÿæ’­æ”¾ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½ï¼Œä½†åªæ’­æ”¾ä¸€æ¬¡ï¼‰
    setTimeout(() => {
      const welcomePlayed = sessionStorage.getItem('welcomePlayed');
      if (!welcomePlayed) {
        sessionStorage.setItem('welcomePlayed', 'true');
        const welcomeMessage = 'æ‚¨å¥½ï¼æˆ‘æ˜¯æ›¹æ“ï¼Œæœ‰ä»€ä¹ˆæƒ³ä¸æˆ‘è®¨è®ºçš„å—ï¼Ÿ';
        speakText(welcomeMessage);
        console.log('æ’­æ”¾æ¬¢è¿è¯­éŸ³');
      } else {
        console.log('æœ¬æ¬¡ä¼šè¯æ¬¢è¿è¯­éŸ³å·²æ’­æ”¾è¿‡ï¼Œè·³è¿‡');
      }
    }, 2000);
  </script>
</body>
</html>
